# Ассемблер для X584ASM

> [!NOTE]
> Эта программа находится в состоянии alpha-тестирования, кроме того, синтаксис
> ассемблера может измениться.

Программа X584ASM является ассемблером для эмулятора
[X584](https://github.com/kodemeister/X584), который понимает набор команд
К584ВМ1 в формате, используемом в программе X584. 

X584ASM является консольной программой, аналогичной FASM, TASM, YASM и прочим
ассемблерам. Она преобразует код в текстовом формате в файл в формате X584,
который понимает как версия 1.33, так и версия 2.0 и выше.

## Работа с X584ASM

### Описание работы

X584ASM принимает на вход файл с расширением asm (возможно любое другое
расширение) и выдаёт файл с расширением x584 (расширение заменяется, если
есть или приписывается, если нет). Итоговый файл будет размещён в папке,
откуда запущена программа.

Чтобы задать название выходного файла, необходимо воспользоваться ключом
`-o`, после которого следует путь к итоговому файлу. Запись

    $ ./x584asm -o dir/output.x584 source.asm

говорит, что из файла `source.asm` будет получен файл `dir/output.x584`.

В ходе работы X584ASM выводит сообщения о работе. При нормальной работе
для данного примера X584ASM выведет в консоль:

    $ ./x584asm -o dir/output.x584 source.asm
    This is X584ASM, version v0.2.7
    Input file: source.asm
    Output written on dir/output.x584

### Синтаксис

X584ASM разбивает исходный текст на знаки следующих типов:

- ключевые слова:

  `РОН0`, `РОН1`, `РОН2`, `РОН3`, `РОН4`, `РОН5`, `РОН6`, `РОН7`,
  `РР`, `РРР`, `ШИНвх`, `Швх`, `ШИНвых`, `ШВых`, `П`, `если`,
  `то`, `иначе`, `иди_на`, `ввод`, `останов`, `ноп`, `стоп`, `пусто`
  (только в составе `<ПУСТО>`, в другом месте - ошибка),
  `ПАЛУ0`, `ПАЛУ1`, `ПАЛУ2`, `ПАЛУ3`, `СДЛ1`, `СДЛ2`, `СДП1`, `СДП2`,
  `РРР0`, `РРР3`, `А15`, `В15`, `и`, `или`, `искл_или`, `СЛЛ`, `СЛП`,
  `СЦЛ`, `СЦП`, `САЛ`, `САП`;

  `RF0`, `RF1`, `RF2`, `RF3`, `RF4`, `RF5`, `RF6`, `RF7`, `WR`, `XWR`,
  `DI`, `DO`, `C`, `ALUCIN`, `if`, `then`, `else`, `goto`, `input`,
  `break`, `nop`, `halt`, `empty`, `ALUCOUT0`, `ALUCOUT1`, `ALUCOUT2`,
  `ALUCOUT3`, `CO0`, `CO1`, `CO2`, `CO3`, `C0`, `C1`, `C2`, `SL1`, `SL2`,
  `SR1`, `SR2`, `WRRT`, `WRLFT`, `XWRRT`, `XWRLFT`, `XWR0`, `XWR3`,
  `A15`, `B15`, `AMSB`, `BMSB`, `and`, `or`, `xor`, `LSL`, `LSR`, `RSL`,
  `RSR`, `ASL`, `ASR`;

- слова, состоящие из букв Юникода (категории Lu, Ll, Lt, Lm, Lo), 
  нижнего подчёркивания `'_'` и прочих символов из категории Pc,
  десятичных цифр и начинающиеся с буквы или нижнего подчёркивания;

- числа, состоящие из десятичных цифр;

- шестнадцатеричные числа, начинающиеся с `0x`;

- аннотации, начинающиеся с `;` или `#` и продолжающиеся до конца
  строки;

- символ `:=`;

- прочие символы.

Комментарии бывают однострочные (начинаются с `//`) и многострочные
(начинаются с `/*` и заканчиваются `*/`). Вложенные многострочные
комментарии не обрабатываются.

Программа представлена в виде последовательности инструкций. Каждая
инструкция состоит из:

- метки в виде слова и двоеточия;

- опкода;

- управляющего оператора;

- одной аннотации, которая может быть вставлена после опкода или
  после управляющего оператора.

> [!CAUTION]
> В версии 0.2.7 недопустима вставка аннотации между меткой и
> опкодом.

Опкод может начинаться со слова `Break` или `Останов`, если в этом
месте необходимо поставить точку останова. В качестве опкода 
может использоваться слово `Nop` или `<Пусто>`. Опкод также
представляет собой выражение по работе над регистрами, разделённое
`:=` или `=`. Формат выражений соответствует используемому в X584,
но допускает некоторые вольности в арифметических действиях, в
частности, в замене переноса на его значение или опускании знака
переноса.

> [!NOTE]
> TODO: сделать описание формата выражений.

### Ошибки

Если в процессе обработки файлов возникает фатальная ошибка, компиляция
останавливается и работа программы прекращается. В консоль могут быть
выведены следующие сообщения:

- `! Fatal error: out of memory`

  Нехватка памяти для работы программы.

- `! Fatal error: input file not specified`

  Входной файл не указан.

- `! Fatal error: invalid option`

  Указан неверный параметр командной строки.

- `! Fatal error: option requires an argument`

  Параметр требует аргумента (такое бывает, если не указать после `-o`
  нужного имени файла)

- `! Fatal error: failed to open input file`

  Не удалось открыть исходный файл.

- `! Fatal error: failed to open output file`

  Не удалось создать итоговый файл.

Если ошибка возникла в процессе парсинга исходного файла, то она выводится
в следующем формате:

    ! Line <L>, column <C>: <Text>

где `<L>` - номер строки, `<C>` - номер столбца в кодоместах Юникода, 
`<Text>` - обозначение ошибки вместе с её номером.

Имеются следующие типы ошибок:

1. `Syntax error`

   Синтаксическая ошибка.

2. `',' expected`

   Ожидалась запятая в выражении расширенного сдвига.

3. `<ПУСТО> expected`

   Ожидался код пустой инструкции.

4. `Flag expected (ПАЛУ0,ПАЛУ1,ПАЛУ2,ПАЛУ3,!СДЛ1,!СДП1,!СДЛ2,!СДП2,РРР0,РРР3,А15,В15)`

   Ожидался флаг в условном выражении.

5. `Label or address expected`

   Ожидалась метка или адрес инструкции.

6. `'(' expected`

   Ожидалась открывающая скобка.

7. `')' expected`

   Ожидалась закрывающая скобка.

8. `Argument expected (РОН0-РОН7,РР,РРР,ШИНвх,Швх,П)`

   Ожидался аргумент.

9. `'then' or 'то' expected`

   Ожидалось слово `то` или `then` в условном выражении.

10. `'xor' expected`

   Ожидался оператор "исключающее или" в выражении вида `РР := !(РОН0 xor РР)`

11. `Invalid address`

   Неверный адрес перехода (адрес меньше 0 или больше 1023).

12. `Invalid carry value`

   Неправильное значение входного переноса (либо `(П=0), либо (П=1)`)

13. `Invalid number`

   Неверное число.

14. `Invalid opcode`

   Неправильная инструкция.

15. `Too many instructions`

   Слишком много инструкций.

16. `Too many labels`

   Слишком много меток.

17. `Unexpected number`

   Неожиданное число.

18. `Unexpected word`

   Неожиданное слово.

19. `Unexpected symbol`

   Неожиданный символ.

20. `Unexpected annotation`

   Неожиданная аннотация.
